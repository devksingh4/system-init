---
- name: Install MacOS Packages
  hosts: localhost
  connection: local
  become: false
  vars:
    brew_cask_packages:
      - docker
      - firefox
      - google-chrome
      - google-drive
      - discord
      - spotify
      - visual-studio-code
      - betterdisplay
      - rectangle
      - mouse-fix
      - microsoft-office
      - cyberduck
      - postman
      - hpedrorodrigues/tools/dockutil
      - bitwarden
      - messenger
      - miniconda
      - basictex
      - slack
      - zoom
    brew_packages:
      - tailscale
      - mas
      - nano
      - wget
      - gpg
      - gpg2
      - pinentry-mac
      - nvm
      - aws-sam-cli
      - node
      - python
      - cfn-lint
      - git
    # mas_packages: 
    #   - 497799835 # xcode
    mas_packages: []

    upgrade_homebrew_packages: true

    dockitems_remove: []
    
    dockitems:
      - "/Applications/Google Chrome.app/"
      - "/Applications/Discord.app/"
      - "/Applications/Microsoft Outlook.app/"
      - "/Applications/Spotify.app/"
      - "/Applications/Messenger.app/"
      - "/Applications/Visual Studio Code.app"
      - "/Applications/Messages.app/"
      - "/System/Applications/Photos.app/"
      - "/Applications/Slack.app/"
      - "/System/Applications/Notes.app/"
      - "/System/Applications/Utilities/Terminal.app/"
      - "/Applications/Microsoft Remote Desktop.app/"
      - "/Applications/zoom.us.app/"

  pre_tasks:
    - name: Ensuring Homebrew Is Installed
      stat:
        path: /opt/homebrew/bin/brew
      register: homebrew_check

    - name: Updating Homebrew
      homebrew:
        update_homebrew: true
      when: homebrew_check.stat.exists

    - name: Upgrading Homebrew Packages
      homebrew:
        upgrade_all: "{{ upgrade_homebrew_packages }}"
        path: /opt/homebrew/bin
      register: result
      until: result is successful
      when: homebrew_check.stat.exists

    - name: Workaround to have sudo rights until timestamp_timeout is raised
      command: "echo hi"
      become: yes

    - name: Installing Homebrew Cask Packages
      shell: /opt/homebrew/bin/brew install --cask {{item}}
      with_items: "{{ brew_cask_packages }}"

    - name: Workaround to have sudo rights until timestamp_timeout is raised
      command: "echo hi"
      become: yes

    - name: Installing Homebrew Packages
      shell: HOMEBREW_NO_AUTO_UPDATE=1 /opt/homebrew/bin/brew install {{item}}
      with_items: "{{ brew_packages }}"

    - name: Workaround to have sudo rights until timestamp_timeout is raised
      command: "echo hi"
      become: yes

    - name: Installing Mac App Store Packages
      shell: mas install {{item}}
      with_items: "{{ mas_packages }}"

    - name: Setup .zshrc
      ansible.builtin.template:
        src: files/.zshrc.j2
        dest: /Users/{{ ansible_user_id }}/.zshrc

    - name: Setup .ssh/config
      ansible.builtin.template:
        src: files/ssh_config.j2
        dest: /Users/{{ ansible_user_id }}/.ssh/config

    - name: Workaround to have sudo rights until timestamp_timeout is raised
      command: "echo hi"
      become: yes

    - name: Remove all from Dock
      shell: dockutil --remove all --no-restart

    - name: Add items to Dock
      shell: |
        dockutil --add {{item}} --no-restart
      with_items: "{{ dockitems }}"

    - name: Setup macOS defaults
      shell: |
        defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false
        defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false
        defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
        defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true 
        defaults write com.apple.dock wvous-br-corner -int 0
        defaults write com.apple.dock wvous-br-modifier -int 0
        defaults write com.apple.dock wvous-tr-corner -int 0
        defaults write com.apple.dock wvous-tr-modifier -int 0
        defaults write com.apple.dock wvous-bl-corner -int 0
        defaults write com.apple.dock wvous-bl-modifier -int 0
        defaults write com.apple.finder "FXPreferredViewStyle" -string "Nlsv"
        defaults write NSGlobalDomain "NSDocumentSaveNewDocumentsToCloud" -bool false
        defaults write com.apple.dock autohide-time-modifier -float 0.3

    - name: Restart Dock
      shell: killall dock
      become: yes

    - name: Install Oh-my-ZSH
      shell: sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
      become: no

